name: Scheduled Maintenance

on:
  schedule:
    - cron: '0 0 * * 1'  # Run every Monday at midnight
  workflow_dispatch:

jobs:
  dependency-updates:
    name: Dependency Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP environment
        uses: ./.github/actions/setup-php

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node

      - name: Setup git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Create maintenance branch
        id: create-branch
        run: |
          BRANCH="maintenance/dep-updates-$(date +'%Y-%m-%d')"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -b $BRANCH

      - name: Update dependencies
        id: update-deps
        run: |
          # Update Composer dependencies
          composer update --no-interaction
          COMPOSER_CHANGES=false
          if [[ -n $(git status --porcelain composer.lock) ]]; then
            COMPOSER_CHANGES=true
            git add composer.lock
            git commit -m "Update Composer dependencies"
          fi

          # Update npm dependencies
          npm update
          NPM_CHANGES=false
          if [[ -n $(git status --porcelain package-lock.json) ]]; then
            NPM_CHANGES=true
            git add package-lock.json
            git commit -m "Update npm dependencies"
          fi

          # Set outputs for next step
          echo "composer_changes=$COMPOSER_CHANGES" >> $GITHUB_OUTPUT
          echo "npm_changes=$NPM_CHANGES" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.update-deps.outputs.composer_changes == 'true' || steps.update-deps.outputs.npm_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: ${{ steps.create-branch.outputs.branch }}
          title: "Maintenance: Dependency updates"
          body: |
            This PR updates dependencies to their latest compatible versions.

            - Composer dependencies: ${{ steps.update-deps.outputs.composer_changes == 'true' && 'Updated' || 'No changes' }}
            - NPM dependencies: ${{ steps.update-deps.outputs.npm_changes == 'true' && 'Updated' || 'No changes' }}

            This PR was automatically created by the maintenance workflow.
          labels: maintenance,dependencies

  housekeeping:
    name: Repository Housekeeping
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Stale Issue & PR Closer
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: 'This issue has been marked as stale due to inactivity. It will be closed in 7 days if no further activity occurs.'
          stale-pr-message: 'This PR has been marked as stale due to inactivity. It will be closed in 14 days if no further activity occurs.'
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          days-before-stale: 60
          days-before-close: 14
          exempt-issue-labels: 'pinned,security,enhancement'
          exempt-pr-labels: 'pinned,security,work-in-progress'